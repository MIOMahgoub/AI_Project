#include <iostream>
#include <fstream>
#include <chrono>
#include <thread>
#include "lidar.h"
#include "ObstacleDetector.h"

int main() {
    Lidar lidar;
    ObstacleDetector detector;
    
    const char* STATUS_FILE = "/tmp/lidar_status.txt";
    
    // Initialize RPLIDAR
    if (!lidar.init("/dev/ttyUSB0")) {
        std::cerr << "ERROR: Unable to init LIDAR.\n";
        return -1;
    }
    
    if (!lidar.start()) {
        std::cerr << "ERROR: Unable to start scanning.\n";
        return -1;
    }
    
    std::cout << "LIDAR running continuously. Writing to " << STATUS_FILE << std::endl;
    std::cout << "Press Ctrl+C to stop." << std::endl;
    
    // Continuous loop
    while (true) {
        std::vector<LidarPoint> points;
        
        // Get one scan
        if (lidar.grabScan(points)) {
            ObstacleInfo info = detector.analyze(points);
            
            // Write to file (atomic write using temp file)
            std::string tempFile = std::string(STATUS_FILE) + ".tmp";
            std::ofstream file(tempFile);
            if (file.is_open()) {
                file << "FRONT:" << (info.frontBlocked ? "1" : "0")
                     << "|LEFT:" << (info.leftBlocked ? "1" : "0")
                     << "|RIGHT:" << (info.rightBlocked ? "1" : "0")
                     << std::endl;
                file.close();
                
                // Atomic rename
                rename(tempFile.c_str(), STATUS_FILE);
            }
        }
        
        // Small delay to prevent CPU overuse (scan ~10Hz)
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
    
    lidar.stop();
    return 0;
}
